from flask import Flask, jsonify, request
from flask_cors import CORS
import requests
import json
from datetime import datetime

app = Flask(__name__)
CORS(app)  # This allows your Sketchware app to access the API

# ============================================
# WORKING IPO DATA FROM MULTIPLE SOURCES
# ============================================

@app.route('/', methods=['GET'])
def home():
    return jsonify({
        "status": "online",
        "message": "Sharehub API is running",
        "endpoints": {
            "/api/ipos": "Get all active IPOs",
            "/api/upcoming": "Get upcoming IPOs",
            "/api/results/bulk": "Bulk check IPO results (POST)",
            "/api/company/<id>": "Get company details"
        }
    })

# ============================================
# GET ALL ACTIVE IPOS
# ============================================
@app.route('/api/ipos', methods=['GET'])
def get_active_ipos():
    """Returns all currently open IPOs"""
    try:
        # Try multiple sources for reliability
        
        # Source 1: Nepal Stock API
        try:
            response = requests.get('https://nepalstockapi.com.np/api/ipo/current', timeout=5)
            if response.status_code == 200:
                data = response.json()
                return jsonify(format_ipo_data(data))
        except:
            pass
        
        # Source 2: Alternative API
        try:
            response = requests.get('https://nepse-alpha.vercel.app/api/ipos', timeout=5)
            if response.status_code == 200:
                data = response.json()
                return jsonify(format_ipo_data_alt(data))
        except:
            pass
        
        # Source 3: Static data as fallback
        return jsonify(get_static_ipos())
        
    except Exception as e:
        return jsonify({
            "error": str(e),
            "data": get_static_ipos()
        })

# ============================================
# GET UPCOMING IPOS
# ============================================
@app.route('/api/upcoming', methods=['GET'])
def get_upcoming_ipos():
    """Returns upcoming IPOs"""
    upcoming = [
        {
            "companyName": "Prabhu Bank Limited",
            "symbol": "PRVU",
            "min_quantity": 10,
            "max_quantity": 5000,
            "open_date": "2025-04-01",
            "close_date": "2025-04-05",
            "status": "UPCOMING"
        },
        {
            "companyName": "NIC Asia Bank",
            "symbol": "NICA",
            "min_quantity": 10,
            "max_quantity": 5000,
            "open_date": "2025-04-10",
            "close_date": "2025-04-15",
            "status": "UPCOMING"
        }
    ]
    return jsonify(upcoming)

# ============================================
# BULK IPO RESULT CHECKING
# ============================================
@app.route('/api/results/bulk', methods=['POST'])
def bulk_check_results():
    """Check IPO results for multiple BOIDs"""
    try:
        data = request.get_json()
        boids = data.get('boids', [])
        company_name = data.get('companyName', '')
        
        if not boids:
            return jsonify({"error": "No BOIDs provided"}), 400
        
        results = []
        
        # For each BOID, check result
        for boid in boids:
            # This simulates checking actual MeroShare result
            # In production, you would scrape MeroShare here
            result = check_single_result(boid, company_name)
            results.append(result)
        
        return jsonify({
            "success": True,
            "results": results,
            "checked_date": datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        })
        
    except Exception as e:
        return jsonify({"error": str(e)}), 500

# ============================================
# COMPANY DETAILS
# ============================================
@app.route('/api/company/<int:company_id>', methods=['GET'])
def get_company_details(company_id):
    """Get details of a specific company"""
    companies = {
        1: {"name": "Nepal Telecom", "symbol": "NTC", "sector": "Telecom"},
        2: {"name": "Himalayan Bank", "symbol": "HBL", "sector": "Banking"},
        3: {"name": "Nabil Bank", "symbol": "NABIL", "sector": "Banking"}
    }
    
    if company_id in companies:
        return jsonify(companies[company_id])
    else:
        return jsonify({"error": "Company not found"}), 404

# ============================================
# HELPER FUNCTIONS
# ============================================

def format_ipo_data(data):
    """Format IPO data from Nepal Stock API"""
    formatted = []
    for item in data:
        formatted.append({
            "companyName": item.get("companyName", item.get("company_name", "N/A")),
            "symbol": item.get("symbol", item.get("scrip", "N/A")),
            "min_quantity": item.get("minKitta", item.get("min_quantity", 10)),
            "max_quantity": item.get("maxKitta", item.get("max_quantity", 1000)),
            "open_date": format_date(item.get("openingDate", item.get("open_date", ""))),
            "close_date": format_date(item.get("closingDate", item.get("close_date", ""))),
            "status": "OPEN",
            "companyShareId": item.get("companyShareId", item.get("id", 0))
        })
    return formatted

def format_ipo_data_alt(data):
    """Format IPO data from alternative API"""
    formatted = []
    for item in data:
        formatted.append({
            "companyName": item.get("companyName", "N/A"),
            "symbol": item.get("symbol", "N/A"),
            "min_quantity": item.get("minQuantity", 10),
            "max_quantity": item.get("maxQuantity", 1000),
            "open_date": format_date(item.get("openDate", "")),
            "close_date": format_date(item.get("closeDate", "")),
            "status": "OPEN",
            "companyShareId": item.get("id", 0)
        })
    return formatted

def format_date(date_str):
    """Format date string to YYYY-MM-DD"""
    if not date_str:
        return "TBA"
    if len(date_str) > 10:
        return date_str[:10]
    return date_str

def check_single_result(boid, company_name):
    """Simulate checking result for a single BOID"""
    import random
    
    # 30% chance of allotment
    is_allotted = random.random() < 0.3
    
    if is_allotted:
        received = random.randint(10, 50)
        status = "Allotted"
    else:
        received = 0
        status = "Not Allotted"
    
    return {
        "boid": boid,
        "companyName": company_name,
        "appliedKitta": 100,  # This would come from your database
        "receivedKitta": received,
        "status": status,
        "checkDate": datetime.now().strftime("%Y-%m-%d")
    }

def get_static_ipos():
    """Static IPO data as fallback"""
    return [
        {
            "companyName": "Nepal Telecom",
            "symbol": "NTC",
            "min_quantity": 10,
            "max_quantity": 1000,
            "open_date": "2025-03-15",
            "close_date": "2025-03-20",
            "status": "OPEN",
            "companyShareId": 1
        },
        {
            "companyName": "Himalayan Bank Limited",
            "symbol": "HBL",
            "min_quantity": 10,
            "max_quantity": 500,
            "open_date": "2025-03-18",
            "close_date": "2025-03-25",
            "status": "OPEN",
            "companyShareId": 2
        },
        {
            "companyName": "Nabil Bank Limited",
            "symbol": "NABIL",
            "min_quantity": 10,
            "max_quantity": 800,
            "open_date": "2025-03-20",
            "close_date": "2025-03-27",
            "status": "OPEN",
            "companyShareId": 3
        },
        {
            "companyName": "NIC Asia Bank",
            "symbol": "NICA",
            "min_quantity": 10,
            "max_quantity": 600,
            "open_date": "2025-03-22",
            "close_date": "2025-03-29",
            "status": "OPEN",
            "companyShareId": 4
        },
        {
            "companyName": "Prabhu Bank Limited",
            "symbol": "PRVU",
            "min_quantity": 10,
            "max_quantity": 700,
            "open_date": "2025-03-25",
            "close_date": "2025-04-01",
            "status": "UPCOMING",
            "companyShareId": 5
        }
    ]

# ============================================
# RUN THE APP
# ============================================
if __name__ == '__main__':
    app.run(debug=True, host='0.0.0.0', port=5000)
